name: CI/CD Pipeline (GHCR)

on:
  push:
    branches: [ "main" ]

env:
  # เปลี่ยนเป็นชื่อ GitHub User ของคุณ (ตัวเล็กทั้งหมด)
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }} # มันจะดึงชื่อ repo มาให้อัตโนมัติ (เช่น kimrama/next-blog)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # อนุญาตให้เขียน package ลง GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # ใช้ Token ชั่วคราวของ GitHub Actions

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # Image จะชื่อ: ghcr.io/username/reponame:latest
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          # ส่ง Secret เข้าไปใช้ใน Script
          envs: REGISTRY, IMAGE_NAME
          script: |
            # 1. Login เข้า GHCR บนเครื่อง Server (โดยใช้ PAT ที่เตรียมไว้)
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 2. ดึง Image ใหม่ (แปลงชื่อให้เป็นตัวพิมพ์เล็กทั้งหมดเพื่อความชัวร์)
            FULL_IMAGE="ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]'):latest"
            docker pull $FULL_IMAGE
            
            # 3. ลบของเก่า
            docker stop next-blog-container || true
            docker rm next-blog-container || true
            
            # 4. รันของใหม่
            docker run -d \
              --name next-blog-container \
              -p 3000:3000 \
              --restart always \
              $FULL_IMAGE
